<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Socket.IO Chat with Friend List</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { display: flex; font-family: Arial, sans-serif; margin: 0; }
    .sidebar { width: 280px; background: #fafafa; border-right: 1px solid #ddd; padding: 10px; height: 100vh; overflow-y: auto; display: flex; flex-direction: column; }
    .sidebar h3 { margin: 0 0 10px; font-size: 18px; color: #333; }
    .friend { display: flex; align-items: center; gap: 10px; padding: 10px; margin-bottom: 8px; background: #fff; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: background 0.2s ease, transform 0.1s ease; }
    .friend:hover { background: #f0f0f0; transform: scale(1.02); }
    .dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .dot.online { background: #4CAF50; }
    .dot.offline { background: #bbb; }
    .friend-info { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
    .friend-top { display: flex; justify-content: space-between; align-items: center; }
    .friend-name { font-weight: bold; font-size: 14px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .friend-time { font-size: 11px; color: gray; flex-shrink: 0; }
    .friend-message { font-size: 13px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
    .chat { flex: 1; display: flex; flex-direction: column; padding: 0; height: 100vh; }
    .chat-header { display: flex; align-items: center; padding: 10px; background: #f7f7f7; border-bottom: 1px solid #ddd; gap: 10px; }
    .chat-header .name { font-weight: bold; font-size: 16px; }
    .messages { flex: 1; border: none; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; background: #fff; }
    .message { max-width: 60%; margin: 5px 0; padding: 8px; border-radius: 8px; display: inline-block; position: relative; }
    .me { background-color: #DCF8C6; align-self: flex-end; text-align: right; }
    .friendMsg { background-color: #FFF; align-self: flex-start; }
    .timestamp { font-size: 10px; color: gray; margin-top: 2px; }
    .logout-btn { margin-bottom: 10px; padding: 8px; border: none; border-radius: 8px; background: #e74c3c; color: white; cursor: pointer; font-weight: bold; transition: background 0.2s ease; }
    .logout-btn:hover { background: #c0392b; }
    .attachment-preview { max-width: 200px; margin-top: 5px; border-radius: 5px; display: block; }
    .preview-container { margin-top: 5px; display: flex; align-items: center; gap: 10px; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h3>Friends</h3>
    <div id="friendList">Loading...</div>
  </div>

  <div class="chat">
    <div class="chat-header" id="chatHeader">
      <span>Select a friend to chat</span>
    </div>
    <div class="messages" id="messages"></div>
    <div style="padding: 10px; border-top: 1px solid #ddd;">
      <input type="text" id="messageInput" placeholder="Type your message..." style="width:50%">
      <input type="file" id="fileInput" multiple>
      <button onclick="sendMessage()">Send</button>
      <div id="filePreview" class="preview-container"></div>
    </div>
  </div>

  <script>
    let token = localStorage.getItem("jwtToken");
    if (!token) {
      token = prompt("Enter your JWT token:");
      if (token) localStorage.setItem("jwtToken", token);
    }

    const socket = io("http://localhost:2000", { auth: { token } });
    let friends = [], selectedFriend = null, myUserId = null;

    socket.on("connect", () => {
      console.log("âœ… Connected to server");
      fetch("http://localhost:2000/messages/friends/list", { headers: { Authorization: `Bearer ${token}` } })
        .then(res => res.json())
        .then(data => {
          friends = data;
          renderFriendList();
          socket.emit("getOnlineStatuses");
        });

      try {
        const payload = JSON.parse(atob(token.split(".")[1]));
        myUserId = payload.id;
      } catch (e) {
        console.error("Failed to decode JWT", e);
      }
    });

    socket.on("userStatusChange", ({ userId, isOnline }) => {
      const friend = friends.find(f => f._id === userId);
      if (friend) {
        friend.isOnline = isOnline;
        renderFriendList();
      }
      if (selectedFriend && selectedFriend._id === userId) {
        updateChatHeader(selectedFriend.name, isOnline);
      }
    });

    socket.on("onlineStatuses", (statuses) => {
      friends.forEach(friend => {
        if (statuses[friend._id] !== undefined) {
          friend.isOnline = statuses[friend._id];
        }
      });
      renderFriendList();
    });

    socket.on("chatHistory", (chat) => {
      selectedFriend = chat.friend;
      updateChatHeader(chat.friend.name, chat.friend.isOnline);
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML = "";
      chat.messages.forEach(msg => renderMessage(msg));
    });

    socket.on("newMessage", (msg) => {
      if (selectedFriend && (msg.sender === selectedFriend._id || msg.sender._id === selectedFriend._id)) {
        renderMessage(msg);
      }
      const friendToUpdate = friends.find(f =>
        f._id === (msg.sender._id || msg.sender) || f._id === (msg.receiver._id || msg.receiver)
      );
      if (friendToUpdate) {
        friendToUpdate.lastMessage = msg.content || (msg.file ? msg.file.filename : "");
        friendToUpdate.lastMessageTime = msg.createdAt || new Date().toISOString();
        renderFriendList();
      }
    });

    function renderFriendList() {
      const container = document.getElementById("friendList");
      container.innerHTML = "";
      const logoutBtn = document.createElement("button");
      logoutBtn.innerText = "Logout";
      logoutBtn.className = "logout-btn";
      logoutBtn.onclick = logout;
      container.appendChild(logoutBtn);

      friends.forEach(friend => {
        const div = document.createElement("div");
        div.className = "friend";
        div.onclick = () => selectFriend(friend);

        const dot = document.createElement("div");
        dot.className = `dot ${friend.isOnline ? "online" : "offline"}`;

        const info = document.createElement("div");
        info.className = "friend-info";

        const top = document.createElement("div");
        top.className = "friend-top";

        const name = document.createElement("span");
        name.className = "friend-name";
        name.innerText = friend.name || friend._id;

        const time = document.createElement("span");
        time.className = "friend-time";
        time.innerText = friend.lastMessageTime
          ? new Date(friend.lastMessageTime).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
          : "";

        const message = document.createElement("span");
        message.className = "friend-message";
        message.innerText = friend.lastMessage || "";

        top.appendChild(name);
        top.appendChild(time);
        info.appendChild(top);
        info.appendChild(message);

        div.appendChild(dot);
        div.appendChild(info);
        container.appendChild(div);
      });
    }

    function updateChatHeader(name, isOnline) {
      const header = document.getElementById("chatHeader");
      header.innerHTML = "";
      const dot = document.createElement("div");
      dot.className = `dot ${isOnline ? "online" : "offline"}`;
      dot.style.marginRight = "5px";
      const nameSpan = document.createElement("span");
      nameSpan.className = "name";
      nameSpan.innerText = name;
      header.appendChild(dot);
      header.appendChild(nameSpan);
    }

    function selectFriend(friend) {
      selectedFriend = friend;
      document.getElementById("messages").innerHTML = "";
      socket.emit("getChatHistory", { friendId: friend._id });
    }

    function renderMessage(msg) {
      const messagesDiv = document.getElementById("messages");
      const wrapper = document.createElement("div");
      wrapper.id = `msg-${msg._id}`;
      wrapper.style.display = "flex";
      wrapper.style.flexDirection = "column";
      wrapper.style.alignItems = msg.isSender ? "flex-end" : "flex-start";

      const bubble = document.createElement("div");
      bubble.className = `message ${msg.isSender ? "me" : "friendMsg"}`;
      bubble.innerHTML = `<span class="bubble">${msg.content || ""}</span>`;

      if (msg.files && msg.files.length > 0) {
        msg.files.forEach(file => {
          let attachment;
          if (file.type.startsWith("image")) {
            attachment = document.createElement("img");
            attachment.src = file.path;
          } else {
            attachment = document.createElement("a");
            attachment.href = file.path;
            attachment.target = "_blank";
            attachment.innerText = `ðŸ“Ž ${file.filename || "Download file"}`;
          }
          attachment.className = "attachment-preview";
          bubble.appendChild(attachment);
        });
      }


      const ts = document.createElement("span");
      ts.className = "timestamp";
      ts.innerText = new Date(msg.createdAt).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

      wrapper.appendChild(bubble);
      wrapper.appendChild(ts);
      messagesDiv.appendChild(wrapper);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    const fileInput = document.getElementById("fileInput");
    const filePreview = document.getElementById("filePreview");
    fileInput.addEventListener("change", () => {
      filePreview.innerHTML = "";
       Array.from(fileInput.files).forEach(file => {
        let previewEl;
        if (file.type.startsWith("image")) {
          previewEl = document.createElement("img");
          previewEl.src = URL.createObjectURL(file);
        } else {
          previewEl = document.createElement("span");
          previewEl.innerText = `ðŸ“Ž ${file.name}`;
        }
        previewEl.className = "attachment-preview";
        filePreview.appendChild(previewEl);
      });
    });

    async function sendMessage() {
      if (!selectedFriend) return alert("Select a friend first");
      const content = document.getElementById("messageInput").value;
      const files = Array.from(fileInput.files);
      if (!content && files.length === 0) return alert("Type message or select file(s)");

      let filePayload = [];
      for (let file of files) {
        const base64 = await fileToBase64(file);
        filePayload.push({ path: base64, filename: file.name, type: file.type });
      }

      const msg = { receiverId: selectedFriend._id, content, files: filePayload };
      socket.emit("sendMessage", msg);

      const newMsg = { _id: Date.now(), sender: myUserId, isSender: true, content, files: filePayload, createdAt: new Date() };
      renderMessage(newMsg);

      selectedFriend.lastMessage = content || (files.length > 0 ? "ðŸ“Ž File(s) sent" : "");
      selectedFriend.lastMessageTime = newMsg.createdAt;
      renderFriendList();

      document.getElementById("messageInput").value = "";
      fileInput.value = "";
      filePreview.innerHTML = "";
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(",")[1]);
        reader.onerror = err => reject(err);
        reader.readAsDataURL(file);
      });
    }

    function logout() { localStorage.removeItem("jwtToken"); window.location.reload(); }
  </script>
</body>
</html>
